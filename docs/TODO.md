# 要検討事項

実装前・実装中に検討が必要な事項をまとめる。
解決したら項目を削除する。

---

## 優先度：高（実装前に決定が必要）

### 1. 元動画の解像度確認

**状況**: 元動画の正確な解像度が未確認

**必要なアクション**:
- 元動画をダウンロードして `ffprobe` で確認
- 出力解像度をこれに合わせる

**影響範囲**: FFmpegコマンド、画像リサイズ処理

---

### 2. 画像のアスペクト比処理

**問題**: ユーザーがアップロードする画像のアスペクト比は様々

**選択肢**:
- A) 中央クロップ（はみ出し部分を切る）
- B) レターボックス（黒帯を入れる）
- C) 引き伸ばし（歪みを許容）
- D) カバー（拡大して全画面、はみ出しは切る）

**推奨**: D（カバー）が自然か？要確認

---

### 3. 同時実行数の決定

**問題**: VPSスペックとのバランス

**方針**:
- 初期は1並列で開始
- **処理時間をDBに記録**して実データを収集
- 実データを見て同時実行数を調整

**必要な実装**:
- Jobテーブルに `processingTimeMs` フィールドを追加
- FFmpeg開始〜終了の時間を計測して保存

---

## 優先度：中（実装中に決定可能）

### 4. アップロード画像の一時保存場所

**選択肢**:
- A) ファイルシステム（`/uploads`）
- B) メモリ（Bufferで保持）

**考慮点**:
- 25枚 × 10MB = 最大250MB
- メモリは同時リクエストで問題になりうる
- ファイルシステムが無難

---

### 5. 生成動画のファイル名形式

**選択肢**:
- A) `{jobId}.mp4`
- B) `{timestamp}_{jobId}.mp4`
- C) `anone_{randomId}.mp4`

**推奨**: A（シンプル）

---

### 6. エラーメッセージの粒度

**問題**: 詳細すぎると攻撃者にヒントを与える

**方針案**:
- ユーザー向け：汎用的なメッセージ
- ログ：詳細なエラー情報

---

### 7. JS難読化ツールの選定

**候補**:
- javascript-obfuscator
- terser（minifyのみ）
- webpack + obfuscator plugin

**考慮点**:
- 難読化レベルとビルド時間のトレードオフ
- デバッグ時の利便性

---

## 優先度：低（後回し可能）

### 8. 古いJob/ファイルの掃除ルール

**現状**: 保存期間は「無期限」としている

**将来検討**:
- ストレージ逼迫時の対応
- node-cronで定期削除するタイミング
- 例：7日経過で削除

---

### 9. 進捗表示の実装方法

**選択肢**:
- A) ポーリング（現状の `/api/status`）
- B) Server-Sent Events
- C) WebSocket

**現状方針**: Aで開始、必要なら拡張

---

### 10. 縦長動画対応

**将来課題**:
- 元動画の縦長版が必要
- UIでの選択機能
- 別のタイムスタンプ配列が必要か？

---

### 11. 複数楽曲対応

**将来課題**:
- 元動画が増えた場合の管理方法
- UIでの選択機能
- タイムスタンプの動的管理

→ 詳細は `ARCHITECTURE.md` を参照

---

## 技術的な疑問点

### Q1. FFmpegクロマキーの色指定

元動画のグリーンバックの正確な色（HEX値）を確認する必要があるか？
→ `colorkey` フィルタのデフォルト（`0x00FF00`）で対応できるか実験

### Q2. 画像切り替えのなめらかさ

1拍（0.47秒）ごとの切り替えは、フェードなしのパッと切り替えで良いか？
→ 元動画の雰囲気に合わせる

---

## 確認済み・解決済み

_解決した項目はここに移動し、後で削除_

- [x] 背景切り替えタイミング → 1拍ごと24枚 + 最後1小節1枚
- [x] ユーザー入力項目 → 画像のみ
- [x] 画像不足時 → ループ
- [x] 出力形式 → 横長（初期）
- [x] デプロイ先 → VPS（Ubuntu）
- [x] PoW difficulty → **4（簡単め）** で開始、必要に応じて調整
- [x] DB選定 → **Prisma**（将来拡張を考慮）
- [x] 処理時間の記録 → **Jobテーブルに `processingTimeMs` を追加**して収集
