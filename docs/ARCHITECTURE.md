# アーキテクチャ検討：将来の拡張パターン

## 背景

将来的に、様々なグリーンバック動画をベースとした「動画メーカー」を量産する可能性がある。
その際のプロジェクト構成パターンを検討し、初期実装時に意識すべき点を整理する。

---

## 構成パターン

### パターンA: モノリス（全て1プロジェクト）

```
video-makers/
├─ server/
│  ├─ src/
│  │  ├─ core/           # 共通処理
│  │  │  ├─ ffmpeg/
│  │  │  ├─ pow/
│  │  │  └─ queue/
│  │  └─ makers/         # 各メーカー固有
│  │     ├─ anone/
│  │     │  ├─ config.ts # タイムスタンプ等
│  │     │  └─ routes.ts
│  │     ├─ other-song/
│  │     └─ ...
│  └─ assets/
│     ├─ anone/
│     │  └─ base.mp4
│     └─ other-song/
└─ public/
   ├─ anone/
   │  └─ index.html
   └─ other-song/
```

**メリット**
- 構成がシンプル
- 共通部分の変更が即反映
- デプロイが1つで済む

**デメリット**
- 1つ壊れると全体に影響
- メーカーが増えるとコード肥大化
- 権利関係が異なる動画の混在が面倒

---

### パターンB: 共通ライブラリ + 個別プロジェクト

```
# 共通ライブラリ（npm packageとして公開 or ローカル参照）
video-maker-core/
├─ src/
│  ├─ ffmpeg/
│  ├─ pow/
│  ├─ queue/
│  └─ types/
└─ package.json

# 個別メーカー（それぞれ独立）
anone-creator/
├─ server/
│  ├─ src/
│  │  ├─ config.ts      # このメーカー固有設定
│  │  └─ index.ts       # coreをimport
│  └─ assets/
│     └─ base.mp4
└─ public/

other-creator/
├─ ...
```

**メリット**
- 各メーカーが独立してデプロイ可能
- 権利関係を分離できる
- 1つ壊れても他に影響しない

**デメリット**
- coreの更新時に各プロジェクトの更新が必要
- 初期構築コストが高い
- npm公開 or モノレポの仕組みが必要

---

### パターンC: モノレポ（pnpm workspace等）

```
video-makers/
├─ packages/
│  ├─ core/              # 共通ライブラリ
│  │  ├─ src/
│  │  └─ package.json
│  ├─ anone-creator/     # 個別メーカー
│  │  ├─ src/
│  │  ├─ assets/
│  │  └─ package.json    # "core": "workspace:*"
│  └─ other-creator/
├─ pnpm-workspace.yaml
└─ package.json
```

**メリット**
- coreと各メーカーを同時に開発できる
- 依存関係がローカルで解決
- 個別デプロイも可能

**デメリット**
- モノレポの学習コスト
- CI/CDがやや複雑

---

## 比較表

| 観点 | A: モノリス | B: 分離 | C: モノレポ |
|------|-------------|---------|-------------|
| 初期コスト | 低 | 高 | 中 |
| 運用コスト | 低 | 中 | 中 |
| 独立デプロイ | 不可 | 可 | 可 |
| 障害影響範囲 | 全体 | 個別 | 個別 |
| 権利分離 | 難 | 易 | 易 |
| coreの更新反映 | 即時 | 手動 | 即時 |

---

## 判断ポイント

### 1. 量産の規模感
- 2〜3個 → A（モノリス）で十分
- 5個以上 → B or C を検討

### 2. 権利関係
- 全て自分の管理 → A
- 他者の楽曲含む → B or C（分離推奨）

### 3. デプロイ戦略
- 1つのVPSで全部 → A or C
- メーカーごとに別サーバー → B

### 4. 開発スタイル
- 一人で管理 → A
- 複数人/公開前提 → B or C

---

## 採用方針

### 初期リリース: パターンAベースで開始

理由：
- まずは1つ動くものを作るのが最優先
- 共通化すべき部分は実装しながら見えてくる
- 2つ目を作る時点でリファクタして分離すれば良い

### 初期実装で意識すること

将来パターンB/Cに移行しやすくするため、以下を意識して実装する：

1. **設定の分離**
   - タイムスタンプ、解像度等は `config.ts` に集約
   - ハードコードしない

2. **FFmpeg処理の汎用化**
   - 元動画パス、タイムスタンプ配列を引数で受け取る設計
   - 特定の楽曲に依存しない

3. **ディレクトリ構造**
   - `core/` と `makers/` を最初から分けておく
   - 後から切り出しやすい

```
server/src/
├─ core/           # 将来切り出す候補
│  ├─ ffmpeg/
│  ├─ pow/
│  ├─ queue/
│  └─ db/
└─ makers/
   └─ anone/       # このメーカー固有
      └─ config.ts
```

---

## 移行シナリオ

### 2つ目のメーカーを作る時

1. `makers/other-song/` を追加
2. 共通処理が十分に汎用化されているか確認
3. 問題なければモノリスのまま継続
4. 分離したい理由（権利、デプロイ等）が出たらパターンCへ移行

### パターンCへの移行手順

1. `pnpm-workspace.yaml` を作成
2. `core/` を `packages/core/` に移動
3. 各メーカーを `packages/xxx-creator/` に移動
4. 依存関係を `workspace:*` に変更
5. 個別の `package.json` を整備

---

## まとめ

- 初期は**シンプルなモノリス**で開始
- ただし**分離しやすい構造**を意識して実装
- 2つ目以降を作る時点で再評価
